<!DOCTYPE html>
<meta charset="UTF-8">

<script src="js/jquery.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

<html>
    <nav class="navbar-light bg-light">
        <a class="navbar-brand" href="index.html">
            <img src="images/icon.png" width="30" height="30" class="d-inline-block align-top" alt=""> MediQuery MCQ app</a>
    </nav>
    <head>
        <title>MediQuery</title>
    </head>

    <body>
        <div class="container" id="app">
            <div class="jumbotron text-center">
                    <h2> {{ question }}</h2>
                    <br></br>
                <div class="btn-group-vertical btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-outline-dark active" id="label1">
                      <input v-on:click="checkAnswer(answerA)" type="radio" name="options" id="answer1" autocomplete="off"> {{ answerA }}
                    </label>
                    <label class="btn btn-outline-dark active" id="label2">
                      <input v-on:click="checkAnswer(answerB)" type="radio" name="options" id="answer2" autocomplete="off"> {{ answerB }}
                    </label>
                    <label class="btn btn-outline-dark active" id="label3">
                      <input v-on:click="checkAnswer(answerC)" type="radio" name="options" id="answer3" autocomplete="off"> {{ answerC }}
                    </label>
                    <label class="btn btn-outline-dark active" id="label4">
                        <input v-on:click="checkAnswer(answerD)" type="radio" name="options" id="answer4" autocomplete="off"> {{ answerD }}
                      </label>
                  </div>

                    <br></br>
                    <div class="btn-group-horizontal" role="group">
                        <button v-on:click="next()" type="button" class="btn btn-outline-success btn-lg" id="nextButton" disabled>Next</button>
                    </div>
            </div>
            <div class="position-relative"></div>
                <div class="position-absolute bottom-0 right-0">
                    <h3>{{ QID }}</h3>
                </div>
            </div>
        </div>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-firestore.js"></script>

        <!--
            START : VueJS scripting
        -->
        <script>
            //Database queries
            let firebaseConfig = {
                apiKey: "AIzaSyDrHxIx-NJh8LxhNa1jw9zu1Y6EZOdv4Kk",
                authDomain: "mediquery-430f7.firebaseapp.com",
                databaseURL: "https://mediquery-430f7.firebaseio.com",
                projectId: "mediquery-430f7",
                storageBucket: "mediquery-430f7.appspot.com",
                messagingSenderId: "313300086775",
                appId: "1:313300086775:web:7e5cffa97977da38bbc8f2",
                measurementId: "G-KS13F48QGP"
            };

            firebase.initializeApp({
                apiKey: firebaseConfig.apiKey,
                authDomain: firebaseConfig.authDomain,
                projectId: firebaseConfig.projectId
            });

            let db = firebase.firestore();
            let level = sessionStorage.getItem('level');
            let type = sessionStorage.getItem('TestType');
            let size = sessionStorage.getItem('TestSize');
            let index = 0;
            let dataArray = [];
            let correctAnswers = 0;
            let selectedAnswer = "";
            
            db.collection(level.toString()).get().then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    dataArray.push(doc.data());
                });

                //Randomise order of array
                shuffleArray(dataArray);
                //Truncate array to chosen test size
                dataArray = dataArray.slice(0, size);
                console.log("Question array length: " + dataArray.length);

                var app = new Vue({
                el: '#app',
                data: {
                    question: dataArray[index].question,
                    answerA: dataArray[index].answer1,
                    answerB: dataArray[index].answer2,
                    answerC: dataArray[index].answer3,
                    answerD: dataArray[index].answer4,
                    QID: dataArray[index].id
                },
                methods: {
                    checkAnswer : function (answer) {
                        document.getElementById("nextButton").disabled = false;
                        selectedAnswer = answer;
                    },
                    next : function () {
                        if (index < dataArray.length - 1)
                        {
                            if (selectedAnswer == dataArray[index].correct)
                            {
                                console.log("Correct answer");
                                correctAnswers++;
                            }
                            index++;
                            this.question = dataArray[index].question;
                            this.answerA = dataArray[index].answer1;
                            this.answerB = dataArray[index].answer2;
                            this.answerC = dataArray[index].answer3;
                            this.answerD = dataArray[index].answer4;
                            this.QID = dataArray[index].id
                            document.getElementById("nextButton").disabled = true;
                            document.getElementById('label1').classList.remove('active');
                            document.getElementById('label2').classList.remove('active');
                            document.getElementById('label3').classList.remove('active');
                            document.getElementById('label4').classList.remove('active');
                        }
                        else
                        {
                            if (selectedAnswer == dataArray[index -1].correct)
                            {
                                console.log("Correct answer");
                                correctAnswers++;
                            }
                            sessionStorage.setItem('score', correctAnswers);
                            location.href = "TestResults.html";
                        }
                    }
                }
            })
            })
            .catch((error) => {
                console.log("Error querying database - QuizPage.html", error);
                return null;
            });
            
            function shuffleArray (array)
            {
                for (var i = array.length - 1; i > 0; i--)
                {
                    var j = Math.floor(Math.random() * (i + 1));
                    var temp = array[i];
                    array[i] = array[j];
                    array[j] = temp;
                }
            }

        </script>
        <!--
            END : VueJS scripting
        -->
    </body>
</html>